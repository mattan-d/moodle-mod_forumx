define(["jquery","core/str","jqueryui"],function(a,b){var c={isRTL:null,loader:null,gallery:{dialog:null,imageHolder:null,spanHolder:null,contentContainer:null,buttonPrev:null,buttonNext:null,buttonClose:null,navCounter:null},str:{},urls:[],images:0,position:0,keyNext:null,keyPrev:null,isFirst:!1,isLast:!1},d=function(a){c.isRTL=a,f(),a?(c.keyPrev=39,c.keyNext=37):(c.keyPrev=37,c.keyNext=39),m()},e=function(){var b,d;c.isRTL?(b="fa-chevron-right",d="fa-chevron-left"):(b="fa-chevron-left",d="fa-chevron-right"),c.gallery.dialog=a('<div class="pgl_main" tabindex="-1" role="dialog"><div class="pgl_body"><div class="pgl_image"><div class="pgl_image_container"><img src="" class="pgl_display hidden_element"><span class="pgl_display hidden_element"></span><button class="pgl_close fa fa-close" title="'+c.str.buttonClose+'"></button><div class="pgl_image_footer"><span class="pgl_counter"></span></div></div></div><button class="pgl_nav pgl_button_start fa '+b+'" title="'+c.str.buttonPrev+'"></button><button class="pgl_nav pgl_button_end fa '+d+' title="'+c.str.buttonNext+'"></button></div></div>'),c.gallery.contentContainer=c.gallery.dialog.find(".pgl_image_container"),c.gallery.imageHolder=c.gallery.dialog.find("img"),c.gallery.spanHolder=c.gallery.dialog.find("span.hidden_element"),c.gallery.buttonPrev=c.gallery.dialog.find(".pgl_button_start"),c.gallery.buttonNext=c.gallery.dialog.find(".pgl_button_end"),c.gallery.buttonClose=c.gallery.dialog.find(".pgl_close"),c.gallery.navCounter=c.gallery.dialog.find(".pgl_counter")},f=function(){b.get_strings([{key:"pgl:loadbutton",component:"forumx"},{key:"pgl:buttonclose",component:"forumx"},{key:"pgl:buttonnext",component:"forumx"},{key:"pgl:buttonprev",component:"forumx"}]).done(function(a){c.str.loadButton=a[0],c.str.buttonClose=a[1],c.str.buttonNext=a[2],c.str.buttonPrev=a[3],e()})},g=function(b){var d;a("#"+b).find("img:not(.emoticon), span.MathJax").each(function(){type="IMG"===this.nodeName?"image":"span","image"===type?c.urls.push({type:type,src:a(this).attr("src"),alt:a(this).attr("alt"),formula:a(this).attr("src").toLowerCase().search("/filter/wiris/")>-1||a(this).attr("src").toLowerCase().search("/filter/tex/")>-1}):"MathJax_Zoom"!==a(this).parent().attr("id")&&(d=a(this).parent().clone(!0),d.find("#MathJax_ZoomFrame").remove(),d.find("span.MathJax").removeAttr("tabindex"),c.urls.push({type:type,html:d,formula:!0}))}),c.images=c.urls.length,j(0,!1),a("body").addClass("noscroll").append(c.gallery.dialog),c.gallery.dialog.show("fade",function(){c.gallery.dialog.focus()})},h=function(a){"image"==c.urls[a].type?c.urls[a].formula?c.gallery.imageHolder.addClass("formula"):c.gallery.imageHolder.removeClass("formula"):c.urls[a].formula?c.gallery.spanHolder.addClass("formula"):c.gallery.spanHolder.removeClass("formula")},i=function(){c.gallery.dialog.hide("fade",function(){c.gallery.dialog.remove(),c.gallery.imageHolder.attr("src","").attr("alt",""),c.gallery.spanHolder.html(""),c.gallery.navCounter.html(""),c.urls=[],c.images=0,c.index=0,c.position=0,c.isfirst=!1,c.isLast=!1,c.loader.focus(),c.loader=null}),a("body").removeClass("noscroll")},j=function(a,b){if(!(0>a||a>=c.images)){c.position=a;var d="image"===c.urls[a].type;b?c.gallery.contentContainer.fadeOut(50,function(){h(a),d?(c.gallery.spanHolder.addClass("hidden_element"),c.gallery.spanHolder.html(""),c.gallery.imageHolder.attr("src",c.urls[a].src).attr("alt",c.urls[a].alt),c.gallery.imageHolder.removeClass("hidden_element")):(c.gallery.imageHolder.addClass("hidden_element"),c.gallery.imageHolder.attr("src","").attr("alt",""),c.gallery.spanHolder.removeClass("hidden_element"),c.gallery.spanHolder.append(c.urls[a].html))}).fadeIn(100):(d?(c.gallery.spanHolder.addClass("hidden_element"),c.gallery.spanHolder.html(""),c.gallery.imageHolder.attr("src",c.urls[a].src).attr("alt",c.urls[a].alt),c.gallery.imageHolder.removeClass("hidden_element")):(c.gallery.imageHolder.addClass("hidden_element"),c.gallery.imageHolder.attr("src","").attr("alt",""),c.gallery.spanHolder.removeClass("hidden_element"),c.gallery.spanHolder.append(c.urls[a].html)),h(a)),0==a?(c.gallery.buttonPrev.is(":focus")&&c.gallery.dialog.focus(),c.gallery.buttonPrev.addClass("hidden_element"),c.isFirst=!0):(c.gallery.buttonPrev.removeClass("hidden_element"),c.isFirst=!1),a==c.urls.length-1?(c.gallery.buttonNext.is(":focus")&&c.gallery.dialog.focus(),c.gallery.buttonNext.addClass("hidden_element"),c.isLast=!0):(c.gallery.buttonNext.removeClass("hidden_element"),c.isLast=!1),c.gallery.navCounter.html(a+1+" / "+c.images)}},k=function(a){27==a?i():a==c.keyNext?j(c.position+1,!0):a==c.keyPrev&&j(c.position-1,!0)},l=function(a,b){return b.length>0&&(b=" "+b),'<button class="pgl_loader'+b+'" data-pgltarget="'+a+'" title="'+c.str.loadButton+'"><i class="fa fa-picture-o"></i></button>'},m=function(){a("body").on("click",".pgl_loader",function(){c.loader=a(this),g(a(this).attr("data-pgltarget"))}),a("body").on("click",".pgl_close",i),a("body").on("click",".pgl_main .pgl_button_start",function(){j(c.position-1,!0),c.isFirst&&c.gallery.buttonNext.focus()}),a("body").on("click",".pgl_main .pgl_button_end",function(){j(c.position+1,!0),c.isLast&&c.gallery.buttonPrev.focus()}),a("body").on("keyup",".pgl_main",function(a){k(a.keyCode)}),a("body").on("keydown",".pgl_main .pgl_button_end",function(a){9!==a.keyCode||a.shiftKey||(a.preventDefault(),c.gallery.buttonClose.focus())}),a("body").on("keydown",".pgl_main .pgl_button_start",function(a){9===a.keyCode&&!a.shiftKey&&c.isLast&&(a.preventDefault(),c.gallery.buttonClose.focus())}),a("body").on("keydown",".pgl_main .pgl_close",function(a){9===a.keyCode&&(1==c.images?a.preventDefault():a.shiftKey&&(a.preventDefault(),c.isLast?c.gallery.buttonPrev.focus():c.gallery.buttonNext.focus()))})};return{init:function(a){d(a)},hasImages:function(a){return a.find("img:not(.emoticon)").length>0||a.find("span.filter_mathjaxloader_equation").length>0},getLoader:function(a,b){return l(a,b)}}});