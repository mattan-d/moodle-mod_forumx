define(["jquery","jqueryui","core/ajax","core/str","mod_ouilforum/accessibility","mod_ouilforum/stagebutton","mod_ouilforum/postgallery","mod_ouilforum/ga","mod_ouilforum/ouilsimplemenu","mod_ouilforum/toast"],function(a,b,c,d,e,f,g,h){var i={forum:0,forumType:"",forumPage:0,singlePage:!0,discussions:0,quickReply:{parent:0,parentOrSibling:0,discussion:0,dialog:null,path:"",title:"",prefix:""},str:{},delDialog:null,delNode:{node:[],postId:0},linkDialog:null,closeDialog:null,forwardDialog:{parent:0,dialog:null,path:""},infoDialog:null,newIcons:{},currentDialog:null,pendingAction:null,toast:null,useHTMLFallback:!1,canCopy:!1,compactMode:null,discussionSub:null,isIE:!1,digestBlockNode:null,digestMenuClass:null,settingType:null,ajaxCall:{targetId:"",methodName:""}},j=function(){var b,c=a(this).attr("data-discussionid"),d=a("#discussion"+c);a(this).hasClass("d_opened")?(d.find(".ouilforum_post").addClass("closed_post"),b=i.str.openDiscussionThread,q(d,!1)):(d.find(".ouilforum_post").removeClass("closed_post"),b=i.str.closeDiscussionThread,d.find(".discussion_new")&&n(d),q(d,!0)),a(this).attr("title",b).attr("aria-label",b).toggleClass("d_opened")},k=function(b){if("keyup"==b.type&&13!=b.keyCode)return!1;var c=a(this).attr("data-postid"),d=a("#post"+c+"container"),e=(d.find(".of_post_header:first"),d.find("#unread"+c));e.length>0&&l(c),d.toggleClass("closed_post"),q(d,!d.hasClass("closed_post")),p(d.closest(".ouilforum_discussion"))},l=function(b){var d=c.call([{methodname:"mod_ouilforum_single_read",args:{forum:i.forum,post:b}}]);d[0].done(function(c){if(c===!0){a("#unread"+b).remove();var d=a("#post"+b),e=t(d),f=o(e,3,!0);0===f&&m(e)}})},m=function(a){a.find(".posts_limit").length?a.find(".numbers").html().length||a.find(".discussion_new").remove():a.find(".discussion_new").remove()},n=function(a){var b=o(a,2,!1);if(0!==b.length){var d=c.call([{methodname:"mod_ouilforum_multiple_read",args:{forum:i.forum,discussionid:a.attr("data-discussionid"),posts:b}}]);d[0].done(function(b){b===!0&&(a.find(".post_new").remove(),m(a))})}},o=function(b,c,d){var e,f,g=[];return f=d?".of_new_post .post_new":".post_new",e=b.find(f),3==c?e.size():1==c?e:(e.each(function(){g.push(a(this).attr("id").substr(6))}),g.join())},p=function(b){var c=b.find("button.discussion_button"),d=0,e=0;0!=c.length&&(b.find(".ouilforum_post").each(function(){d++,a(this).hasClass("closed_post")&&e++}),0==e?c.addClass("d_opened"):e==d&&c.removeClass("d_opened"))},q=function(a,b){a.find(".post_subject").attr("aria-expanded",b),a.find(".of_post_main").attr("aria-hidden",!b)},r=function(b){b.preventDefault();var d=a(this),f=d.attr("data-flagvalue"),g=d.closest(".simpleactionmenu"),h=g.find("> button");if(f!=g.attr("data-flagstatus")&&!e.isWaiting(h)){var j=t(a(this),!0),k=g.attr("data-postid");e.setWait(h,!0);var l=c.call([{methodname:"mod_ouilforum_flag_post",args:{action:f,post:k,discussion:j}}]);l[0].done(function(a){e.setWait(h,!1);var b=0==f?i.str.flagMenuNone:i.str.flagMenu+" "+f;g.attr("data-postid",f).attr("data-flagstatus",f),h.attr("title",b),e.informScreenReader(h,i.str.done,b,"aria-label")}).fail(function(a){e.setWait(h,!1),X(h,!0,"aria-label",h.attr("aria-label"))})}},s=function(b){b.preventDefault();var d=a(this);if(!e.isWaiting(d)){var f=d.attr("data-action"),g=d.attr("data-postid"),h=t(d,!0);e.setWait(d,!0);var j=c.call([{methodname:"mod_ouilforum_recommend_post",args:{action:f,post:g,discussion:h}}]);j[0].done(function(a){e.setWait(d,!1);var b;"recommendpost"==f?(d.attr("data-action","unrecommendpost"),b=i.str.unrecommendPost):(d.attr("data-action","recommendpost"),b=i.str.recommendPost),d.attr("title",b),e.informScreenReader(d,i.str.done,b,"aria-label")}).fail(function(a){e.setWait(d,!1),X(d,!0,"aria-label",d.attr("aria-label"))})}},t=function(a,b){var c=a.closest(".ouilforum_discussion");return b?c.attr("data-discussionid"):c},u=function(a,b){a.find('input[type="text"], input[type="email"], textarea').val(""),a.find('input[type="checkbox"]').prop("checked",!1),a.find("button").prop("disable",!1),a.find(".dialog_field_alert_label").remove(),a.find(".empty_field_alert").removeClass("empty_field_alert"),a.find(".quick_dialog_alert").html(""),b&&a.find(".waitmask").addClass("hidden_element").removeClass("active")},v=function(a){a?i.quickReply.dialog.find(".conditional_button").removeClass("hidden_element"):i.quickReply.dialog.find(".conditional_button").addClass("hidden_element")},w=function(){a("#newpostbody .empty_field_alert").removeClass("empty_field_alert");var b=a("#newposttop span").html(),d=a.trim(a("#quickreplysubject").val()),e=a("#newpostbody textarea"),f=a.trim(e.val()),g=!1;if(0==f.length&&0==d.length&&(g=!0,e.addClass("empty_field_alert")),!g){var j=a("#post"+i.quickReply.parent+"container"),k=1;(j.hasClass("postlevel1")||j.hasClass("postlevel2"))&&(k=2),d.length>0&&(b=d),oa("quickpostmask",!0,!1),y("reply");var l=c.call([{methodname:"mod_ouilforum_add_quick_discussion_post",args:{postid:i.quickReply.parent,subject:b,message:f,ashtml:1,postlevel:k,options:[{name:"discussionsubscribe",value:0}]}}]);l[0].done(function(b){if(b.error)a("#quickpostmask").removeClass("active").delay(1).queue(function(){if(a(this).addClass("hidden_element").dequeue(),i.quickReply.dialog.find(".quick_dialog_alert").html(b.errormessage),"locked"==b.errortype){var c=t(j),d=c.find('.of_post_icons button[data-actiontype="lock"]');Q(c,!0,b.replybutton,d,b.lockicon),v(!1)}});else{la(!0);var c,d=a.parseHTML(b.post);h.send("addpost",b.postid),b.singlepost?(B(a(d),j),a(d).addClass("new_quick_discussion"),A(a(d))):(c=t(j),C(a(d),c,b.postid))}}).fail(function(b){oa("quickpostmask",!1,!1),a('#newpostbody input[name="subject"]').addClass("empty_field_alert"),a("#newpostbody textarea").addClass("empty_field_alert")})}},x=function(a,b){var c;return c=a.hasClass("firstpost")||a.hasClass("postlevel1")?a:a.closest(".indentlevel1").find(".ouilforum_post.postlevel1"),b?c.attr("data-postid"):c},y=function(b){"discussion"==b?(i.ajaxCall.targetId="quickdiscussionmask",i.ajaxCall.methodName="mod_ouilforum_add_quick_discussion"):"reply"==b&&(i.ajaxCall.targetId="quickpostmask",i.ajaxCall.methodName="mod_ouilforum_add_quick_discussion_post"),a(document).unbind("ajaxComplete",z),a(document).bind("ajaxComplete",z)},z=function(b,c,d){d.context[0].methodname==i.ajaxCall.methodName&&(a(document).unbind("ajaxComplete",z),(200==c.status&&""==c.responseText.length||c.status>=500)&&(oa(i.ajaxCall.targetId,!1,!1),a("#"+i.ajaxCall.targetId).closest(".quicknewdialog").find(".quick_dialog_alert").html(i.str.postingFailed),i.ajaxCall.targetId="",i.ajaxCall.methodName=""))},A=function(b){b.inView(!0)||a("html, body").animate({scrollTop:b.find("a.post_anchor").offset().top},{duration:800,complete:function(){b.find(".post_subject").focus()}})},B=function(b,c){if(c.hasClass("firstpost")){t(c).find(".lastpost").removeClass("lastpost"),b.find(".ouilforum_post").addClass("lastpost");var d=c.next(".discussionslist");d.append(b)}else{var d=c.nextAll(".indent");if(d.length>0){var e=d.find(".lastpost");e.length>0&&(e.removeClass("lastpost"),b.find(".ouilforum_post").addClass("lastpost")),d.last().after(b)}else c.hasClass("lastpost")&&(c.removeClass("lastpost"),b.find(".ouilforum_post").addClass("lastpost")),c.after(b)}a(b).find(".simpleactionmenu").each(function(){a(this).ouilsimpleMenu()}),D(t(c))},C=function(b,c,d){D(c),c.css("minHeight",c.css("height")),b.css("display","none"),c.find(".discussionslist").fadeOut(200,function(){a(this).remove(),c.append(b),b.find(".simpleactionmenu").each(function(){a(this).ouilsimpleMenu()}),ra("#"+c.attr("id")),b.fadeIn(400,function(){if(c.css("minHeight",""),d>0){var b=a("#post"+d+"container");b.addClass("new_quick_discussion"),A(b)}})})},D=function(a){var b=a.find(".ouilforum_post").length-1,c="",d="";b>0&&(c=1==b?i.str.discussionReply:i.str.discussionReplies.replace("#",b),d="("+b+")"),a.find(".discussion_subject .for-sr").html(c),a.find(".discussion_subject .numbers").html(d)},E=function(a){var b;return b=a.hasClass("firstpost")?t(a).find(".ouilforum_post").length-1:a.closest(".indent").find(".ouilforum_post").length-1},F=function(){var b=c.call([{methodname:"mod_ouilforum_delete_post",args:{postid:i.delNode.postId}}]);b[0].done(function(b){a("#del_dialog").next().find("button").prop("disabled",!1),i.delDialog.dialog("close");var c;i.delNode.isDiscussion||(c=t(i.delNode.node)),b.button&&(a(".forummode_container").prepend(b.button),a("ul.discussionslist").before(b.dialog),a(".forummode_container div.alert-danger").remove()),i.delNode.node.animate({height:0},500).delay(50).queue(function(){i.delNode.node.remove(),a(this).dequeue();var b=i.delNode.node.find(".lastpost").length>0;i.delNode.isDiscussion?(i.discussions--,0==i.discussions&&i.singlePage&&a(".forumnodiscuss").removeClass("hidden_element")):(D(c),p(c),b&&c.find(".ouilforum_post").last().addClass("lastpost")),G()})}).fail(function(b){a("#del_dialog").next().find("button").prop("disabled",!1),"errorcode"in b&&"cannotdeletepost"==b.errorcode&&(i.delNode.node.find('.simpleactionmenu a[data-action="delete"]').closest("li").remove(),i.delDialog.parent().addClass("set_noconfirmdlg")),i.delDialog.html(b.message)})},G=function(){i.delNode.node=[],i.delNode.isDiscussion=!1,i.delNode.postId=0},H=function(){var b=a(this);e.isWaiting(b)||(i.compactMode?(f.hasOptions()||f.setOptions(b.next(),b.closest(".stage_button_container").attr("id"),I),f.setDisplay()):(e.setWait(b,!0),I(b)))},I=function(b){var d=b.attr("data-discussionid"),g=b.attr("data-actiontype"),h=c.call([{methodname:"mod_ouilforum_subscribe_discussion",args:{discussion:d,subscribe:g}}]);h[0].done(function(c){if(e.setWait(b,!1),c.error){var d=a("#subscribeforum");"unsubscribable"==c.errortype?(d.remove(),a(".sub_discussion > div").remove()):"subscribed"==c.errortype&&(a(".sub_discussion > div").remove(),d.attr("data-actiontype","unsubscribe").attr("data-buttonstate","on").attr("aria-label",i.str.subscribeForumNoLabel),f.setState(b.next(),!0),d.find(".button_text").html(i.str.subscribeForumNo)),c.errormessage&&(i.infoDialog.find("#info_dialog_content").html(c.errormessage),i.infoDialog.dialog("open"))}else{var h,j,k,l;"subscribe"==g?(j=h=i.str.subscribeDiscussionYesLabel+", "+i.str.enabled,k="unsubscribe",l="on"):(j=h=i.str.subscribeDiscussionYesLabel+", "+i.str.disabled,k="subscribe",l="off"),f.setState(b.next(),"on"==l),b.attr("data-actiontype",k).attr("data-buttonstate",l).attr("title",h),e.informScreenReader(b,i.str.done,j,"aria-label")}}).fail(function(){e.setWait(b,!1),X(b,!0,"aria-label",b.attr("aria-label"))})},J=function(){var b=a(this);e.isWaiting(b)||(i.compactMode?(f.hasOptions()||f.setOptions(b.next(),b.closest(".stage_button_container").attr("id"),K),f.setDisplay()):(e.setWait(b,!0),K(b)))},K=function(b){var d=b.attr("data-forumid"),g=b.attr("data-actiontype"),h=c.call([{methodname:"mod_ouilforum_subscribe_forum",args:{forumid:d,subscribe:g}}]);h[0].done(function(c){if(e.setWait(b,!1),1==c){var d,h,j,k;if("subscribe"==g?(d=h=i.str.subscribeForumYesLabel+", "+i.str.enabled,j="unsubscribe",k="on",a(".sub_discussion > div").remove()):(d=h=i.str.subscribeForumYesLabel+", "+i.str.disabled,j="subscribe",k="off",a(".ouilforum_post .sub_discussion").each(function(){var b=i.discussionSub.clone(),c=a(this).attr("data-discussionid");a(this).append(b),a(this).html(a(this).html().replace(/\{\{f\}\}/g,i.forum).replace(/\{\{d\}\}/g,c)),f.addDialog(a(this).find(".stage_button_container"))})),f.setState(b.next(),"on"==k),f.updateTitle(b.next(),i.str.subscribeForumYesLabel),b.attr("data-actiontype",j).attr("data-buttonstate",k).attr("title",h),i.digestBlockNode){var l="off"==k;i.digestBlockNode.setClass("hidden_element",l),i.digestBlockNode.parent().find(".subscribe_digestmode").setClass("hidden_element",l),l&&L()}e.informScreenReader(b,i.str.done,d,"aria-label")}}).fail(function(a){e.setWait(b,!1),X(b,!0,"aria-label",b.attr("aria-label"))})},L=function(){if("block"==i.settingType){var a=i.digestBlockNode.find(".activesetting");if(a.hasClass("digestmode_0"))return;var b=i.digestBlockNode.find(".digestmode_0"),c=b.find("a").html();b.html('<span tabindex="-1">'+c+"</span>").addClass("activesetting");var d=a[0].className.match(/digestmode_(\d)/i);null!==d&&(c=a.find("span").html(),a.html('<a href="'+M.cfg.wwwroot+"/mod/ouilforum/maildigest.php?id="+i.forum+"&amp;maildigest="+d[1]+"&amp;sesskey="+M.cfg.sesskey+'" tabindex="-1">'+c+"</a>").removeClass("activesetting"))}else{var e=i.digestBlockNode.parent(),f=e.find(".subscribe_digestmode .activesetting");if(f.hasClass("digestmode_0"))return;var b=e.find(".digestmode_0").parent(),g=b.find("i");g[0].className=g[0].className.replace("fa fa-fw","fa fa-check");var c=b.find("a").html();b.html('<span class="currentlink '+i.digestMenuClass+' digestmode_0 activesetting" role="menuitem">'+c+"</span>");var d=f[0].className.match(/digestmode_(\d)/i);if(null!==d){var h=f.parent();g=f.find("i"),g[0].className=g[0].className.replace("fa fa-check","fa fa-fw"),c=f.html(),h.html('<a href="'+M.cfg.wwwroot+"/mod/ouilforum/maildigest.php?id="+i.forum+"&amp;maildigest="+d[1]+"&amp;sesskey="+M.cfg.sesskey+'" class="'+i.digestMenuClass+" digestmode_"+d[1]+'" role="menuitem">'+c+"</a>")}}},N=function(){var b=a(this);e.isWaiting(b)||(i.compactMode?(f.hasOptions()||f.setOptions(b.next(),b.closest(".stage_button_container").attr("id"),O),f.setDisplay()):(e.setWait(b,!0),O(b)))},O=function(b){e.setWait(b,!0);var d=b.attr("data-forumid"),g=b.attr("data-actiontype"),h=[],j=0;"track"==g&&a("#region-main .discussionslist .ouilforum_discussion").each(function(){h.push(a(this).attr("data-discussionid"))}),h.length&&(j=h.join());var k=c.call([{methodname:"mod_ouilforum_track_forum",args:{forumid:d,track:g,inview:!0,discussions:j}}]);k[0].done(function(a){if(e.setWait(b,!1),0!=a.result){var c,d,h,j,k=JSON.parse(a.unread);"track"==g?(c=d=i.str.trackForumYesLabel+", "+i.str.enabled,h="untrack",j="on",P(!0,k)):(c=d=i.str.trackForumYesLabel+", "+i.str.disabled,h="track",j="off",P(!1,k)),f.setState(b.next(),"on"==j),b.attr("data-actiontype",h).attr("data-buttonstate",j).attr("title",d),e.informScreenReader(b,i.str.done,c,"aria-label")}}).fail(function(a){e.setWait(b,!1),X(b,!0,"aria-label",b.attr("aria-label"))})},P=function(b,c){if(b){if(!a.isEmptyObject(c)){var d;a.each(c,function(b,c){var e=a("#discussion"+b+" .ouilforum_post.firstpost .of_post_title");0!=e.length&&(e.prepend(i.newIcons.discussion),a.each(c,function(b,c){d=a("#post"+c+"container"),0!=d.length&&(d.hasClass("firstpost")?d.find("div.author").after(i.newIcons.firstpost.replace("{postid}",c)):d.find(".of_post_title").prepend(i.newIcons.post.replace("{postid}",c)))}))})}}else{var e=a("#region-main ul.discussionslist");e.length>0&&(e.find(".of_new_post").remove(),e.find(".firstpost_new").remove())}},Q=function(a,b,c,d,e){var f=a.find(".post_reply_button");f.length>0&&f.replaceWith(c),"undefined"==typeof d||0==d.length?a.find(".of_post_icons").prepend(e):b?d.removeClass("ouilforum_lock").addClass("ouilforum_unlock").attr("data-action","unlock").attr("title",i.str.unlockDiscussion):(d.removeClass("ouilforum_unlock").addClass("ouilforum_lock").attr("data-action","lock").attr("title",i.str.lockDiscussion),"post"==i.currentDialog&&(v(!0),i.quickReply.dialog.find(".quick_dialog_alert").html("")))},R=function(a){return S(a)?(i.pendingAction=null,!1):T(a)?!0:(i.closeDialog.dialog("open"),!1)},S=function(a){var b=a.find(".waitmask");return 0==b.length?!1:b.hasClass("active")},T=function(b){var c=!0;return b.find('[data-required="true"]').each(function(){c=c&&0==a.trim(a(this).val()).length}),c},U=function(a){i.delNode.isDiscussion=a.hasClass("firstpost"),i.delNode.postId=a.attr("data-postid"),i.delNode.node=i.delNode.isDiscussion?a.closest("li"):a.closest(".indent"),i.delNode.node.setClass("delete_state",!0);var b=E(a),c=0==b?i.str.delSure:i.str.delSurePlural.replace("#",b);i.delDialog.html(c),i.delDialog.dialog("open")},V=function(a){i.linkDialog.find("input").val(a.attr("href")),i.linkDialog.dialog("open"),i.canCopy?i.linkDialog.next().find("button:first").prop("disabled",!1).focus():(i.linkDialog.next().find("button:first").prop("disabled",!0),i.linkDialog.find("#link_copy_result").html(i.str.copyLinkNotSupported))},W=function(b){b.preventDefault();var d=a(this);if(!e.isWaiting(d)){var f=d.attr("data-action"),g=d.attr("data-discussionid"),h=a("#discussion"+g);if("lock"==f&&null!=i.currentDialog&&"post"==i.currentDialog&&i.quickReply.discussion==g)return i.pendingAction=d,void a('#quicknewpost button[data-action="cancel"]').click();i.pendingAction=null,e.setWait(d,!0);var j=c.call([{methodname:"mod_ouilforum_lock_discussion",args:{forumid:i.forum,discussionid:g,lock:f}}]);j[0].done(function(a){if(e.setWait(d,!1),0!=a){var b;b="lock"==f?i.str.unlockDiscussion:i.str.lockDiscussion,Q(h,"lock"==f,a,d),e.informScreenReader(d,i.str.done,b,"aria-label")}}).fail(function(a){e.setWait(d,!1),X(d,!0,"aria-label",d.attr("aria-label"))})}},X=function(a,b,c,d){e.markActionFail(a),b&&i.toast.toast("show",i.str.fail),c&&e.informScreenReader(a,i.str.fail,d,c)},Y=function(){i.delDialog=a('<div id="del_dialog"></div>'),i.delDialog.dialog({dialogClass:"no-close",resizable:!1,height:"auto",width:340,autoOpen:!1,modal:!0,draggable:!1,title:i.str.del,create:function(b,c){a(this).parent().addClass("of_clean_dialog").attr("id","ui_del_dialog"),a(this).parent().find("button")[1].className+=" confirmbtndlg"},close:function(b,c){a(this).parent().removeClass("set_noconfirmdlg")},buttons:[{text:i.str.del,click:function(){a("#del_dialog").next().find("button").prop("disabled",!0),F()}},{text:i.str.cancel,click:function(){i.delNode.node.setClass("delete_state",!1),G(),a(this).dialog("close")}}],beforeClose:function(a){"undefined"!=typeof a.keyCode&&27==a.keyCode&&(i.delNode.node.setClass("delete_state",!1),G())}})},Z=function(){i.closeDialog=a('<div id="close_dialog"></div>'),i.closeDialog.dialog({dialogClass:"no-close",resizable:!1,height:"auto",width:340,autoOpen:!1,modal:!0,draggable:!1,title:i.str.confirmDiscardContent,create:function(b,c){a(this).parent().addClass("of_clean_dialog").attr("id","ui_close_dialog")},open:function(b,c){var d;d="post"==i.currentDialog&&i.pendingAction&&"lock"==i.pendingAction.attr("data-actiontype")?i.str.confirmDiscardContentLock:i.str.confirmDiscardContent,i.closeDialog.dialog("option","title",d),a("body").addClass("noscroll")},buttons:[{text:i.str.confirm,click:function(){a("body").removeClass("noscroll"),a(this).dialog("close"),"post"==i.currentDialog?la(!1):"discussion"==i.currentDialog?ga(!1):"forward"==i.currentDialog&&da()}},{text:i.str.cancel,click:function(){i.pendingAction=null,a("body").removeClass("noscroll"),a(this).dialog("close")}}]})},$=function(){i.linkDialog=a('<div id="link_dialog"></div>'),i.linkDialog.html('<span id="link_path_label" class="for-sr">'+i.str.linkToPostField+'</span><input id="post_link_path" aria-labelledby="link_path_label"><div id="link_copy_result"></div>'),i.linkDialog.find("input").prop("readonly",!0),i.linkDialog.dialog({resizable:!1,closeText:"",height:"auto",width:340,autoOpen:!1,modal:!0,draggable:!1,title:i.str.copyLinkTitle,close:function(){i.linkDialog.find("input").val("")},create:function(b,c){a(this).parent().addClass("of_clean_dialog").attr("id","ui_link_dialog");var d=a(this).parent().find(".ui-dialog-titlebar-close");d.addClass("float_start fa fa-close").attr("title",i.str.copyLinkClose),d.find("span").attr("aria-hidden",!0)},buttons:[{text:i.str.copyLinkCopy,click:function(){var b=a(this).parent().find(".ui-dialog-buttonset button:first");i.linkDialog.find("input").select(),document.execCommand("copy")?(i.toast.toast("show",i.str.copyLinkCopied),e.informScreenReader(b,i.str.done,"","aria-label")):(i.toast.toast("show",i.str.copyLinkFailed),e.informScreenReader(b,i.str.fail,"","aria-label")),i.linkDialog.find("input").blur(),b.focus()}},{text:i.str.copyLinkGoTo,click:function(){var b=i.linkDialog.find("input").val();a(this).dialog("close"),window.location.href=b}}]}),i.linkDialog.find("input").click(function(){a(this).select()})},_=function(){i.infoDialog=a('<div id="info_dialog"><div id="info_dialog_content"></div></div>'),i.infoDialog.dialog({dialogClass:"no-close",resizable:!1,height:"auto",minWidth:200,maxWidth:600,autoOpen:!1,modal:!0,draggable:!1,create:function(b,c){a(this).parent().addClass("of_clean_dialog").attr("id","ui_info_dialog")},buttons:[{text:i.str.copyLinkClose,click:function(){a(this).dialog("close"),a(this).find("#info_dialog_content").html("")}}]})},aa=function(){i.forwardDialog.dialog=a('<div id="forward_dialog"></div>'),i.forwardDialog.dialog.html(a("#quickforward").remove().removeClass("hidden_element")),i.forwardDialog.path=i.forwardDialog.dialog.find("form").attr("action"),i.forwardDialog.dialog.dialog({dialogClass:"no-close",resizable:!1,height:"auto",width:340,autoOpen:!1,modal:!0,draggable:!1,title:i.str.forwardTitle,create:function(b,c){a(this).parent().addClass("of_clean_dialog").attr("id","ui_forward_dialog")},beforeClose:function(b,c){return b.originalEvent&&!R(a("#quickforward"))?!1:void 0},close:function(a,b){i.forwardDialog.parent=0,u(i.forwardDialog.dialog,!0),i.currentDialog=null}}),a("#cancelforward").click(function(b){b.preventDefault(),R(a("#quickforward"))&&da()}),a("#sendforward").click(function(a){a.preventDefault(),ca()}),a("#advancedforward").click(function(a){var b=i.forwardDialog.dialog.find("#forwardemail");b[0].checkValidity()||(b.addClass("empty_field_alert"),a.preventDefault())})},ba=function(a,b){i.currentDialog="forward",i.forwardDialog.path=a,i.forwardDialog.parent=b.attr("data-postid"),i.forwardDialog.dialog.find("form").attr("action",i.forwardDialog.path),i.forwardDialog.dialog.find("form #forwardsubject").val(b.find(".post_subject").html()),i.forwardDialog.dialog.dialog("open")},ca=function(){i.forwardDialog.dialog.find(".empty_field_alert").removeClass("empty_field_alert"),i.forwardDialog.dialog.find(".dialog_field_alert_label").remove(),i.forwardDialog.dialog.find(".quick_dialog_alert").html("");var b=i.forwardDialog.dialog.find("#forwardemail"),d=i.forwardDialog.dialog.find("#forwardsubject"),e=i.forwardDialog.dialog.find("#forwardcontent"),f=!1;0==a.trim(e.val()).length&&(f=!0,e.addClass("empty_field_alert"),ea(e,i.str.forwardErrorEmpty,!0,!1)),0==a.trim(d.val()).length&&(f=!0,d.addClass("empty_field_alert"),ea(d,i.str.forwardErrorEmpty,!0,!1));var g=0==a.trim(b.val()).length;if(g||!b[0].checkValidity()){f=!0,b.addClass("empty_field_alert");var h=g?i.str.forwardErrorEmpty:i.str.forwardErrorInvalidEmail;ea(b,h,!0,!1)}if(f)return void i.forwardDialog.dialog.find(".dialog_field_alert_label:first").focus();oa("forwardmask",!0,!1),i.forwardDialog.dialog.find("button").prop("disabled",!0);var j=c.call([{methodname:"mod_ouilforum_quick_forward_post",args:{postid:i.forwardDialog.parent,forumid:i.forum,email:b.val(),subject:d.val(),ccme:i.forwardDialog.dialog.find("#ccme").is(":checked"),message:e.val()}}]);j[0].done(function(a){i.forwardDialog.dialog.find("button").prop("disabled",!1),oa("forwardmask",!1,!1),a.error?(i.forwardDialog.dialog.find(".quick_dialog_alert").html(a.errormessage),"email"==a.errortype&&(b.addClass("empty_field_alert"),ea(b,a.errormessage,!0,!0))):(i.toast.toast("show",i.str.forwardSent),da())}).fail(function(a){i.forwardDialog.dialog.find("button").prop("disabled",!1),oa("forwardmask",!1,!1),i.forwardDialog.dialog.find(".quick_dialog_alert").html(i.str.fail),i.toast.toast("show",i.str.fail)})},da=function(){i.forwardDialog.dialog.dialog("close")},ea=function(b,c,d,e){if(d){var f=a('<span tabindex="0" class="dialog_field_alert_label">'+c+"</span>");f.insertBefore(b),e&&f.focus()}else b.prev(".dialog_field_alert_label").remove()},fa=function(){a("#region-main").on("click","#addquickdiscussion",function(){return a(this).hasClass("wait_for_dialog")?void a("#quicknew"+i.currentDialog+' button[data-action="cancel"]').click():null!=i.currentDialog?(i.pendingAction=a(this),void a("#quicknew"+i.currentDialog+' button[data-action="cancel"]').click()):(a(this).addClass("wait_for_dialog"),i.currentDialog="discussion",a("#quickdiscussioncontainer").removeClass("hidden_element").delay(1).queue(function(){a(this).removeClass("closed_dialog").dequeue()}).delay(200).queue(function(){a(this).find('input[type="text"]').focus(),a(this).dequeue()}),void 0)}),a("#region-main").on("click","#cancelquickdiscussion",function(b){b.preventDefault(),R(a("#quicknewdiscussion"))&&ga(!1)}),a("#region-main").on("click","#sendquickdiscussion",function(b){b.preventDefault(),a("#newdiscussionfooter button").prop("disable",!0),ha()})},ga=function(b){var c=a("#quickdiscussioncontainer");i.currentDialog=null,a("#newdiscussionbody .empty_field_alert").removeClass("empty_field_alert"),b||null!=i.pendingAction?(c.addClass("closed_dialog").addClass("hidden_element"),u(c,!0),a("#addquickdiscussion").removeClass("wait_for_dialog")):c.addClass("closed_dialog").delay(400).queue(function(){u(a(this),!1),a(this).addClass("hidden_element").dequeue(),oa("quickdiscussionmask",!1,!0),null==i.pendingAction&&a("#addquickdiscussion").removeClass("wait_for_dialog").focus()}),null!=i.pendingAction&&(i.pendingAction.focus().click(),i.pendingAction=null)},ha=function(){a("#newdiscussionbody .empty_field_alert").removeClass("empty_field_alert");var b=a('#newdiscussionbody input[name="quicksubject"]'),d=a.trim(b.val()),e=a("#newdiscussionbody textarea"),f=a.trim(e.val()),g=a("#quicknewdiscussion #quickdiscussiongroupid").val(),j=!1;if(0==d.length&&(j=!0,b.addClass("empty_field_alert")),!j){var k={forumid:i.forum,subject:d,message:f,groupid:g,ashtml:1,options:[{name:"discussionsubscribe",value:0}]},l=a("#newdiscussionbody #posttomygroups");l.length>0&&l.is(":checked")&&(k.togroups=1),oa("quickdiscussionmask",!0,!1),y("discussion");var m=c.call([{methodname:"mod_ouilforum_add_quick_discussion",args:k}]);m[0].done(function(b){ga(!0);var c=a.parseHTML(b);a(c).addClass("new_quick_discussion");var d=a("ul.discussionslist"),e=d.find("li.discussionslist.pinned");0==e.length?d.prepend(c):a(e[e.length-1]).after(c),a(c).find(".simpleactionmenu").each(function(){a(this).ouilsimpleMenu()}),a(c[0]).inView(!0)||a("html, body").animate({scrollTop:a(c[0]).find("a.post_anchor").offset().top},800),i.discussions+=c.length,1==i.discussions&&a(".forumnodiscuss").addClass("hidden_element");a(c).find("div.ouilforum_discussion").each(function(){h.send("adddiscussion",a(this).attr("data-discussionid"))}),"eachuser"==i.forumType&&(a("#addquickdiscussion").remove(),a("#quickdiscussioncontainer").remove()),a()}).fail(function(b){oa("quickdiscussionmask",!1,!1),a('#newdiscussionbody input[name="subject"]').addClass("empty_field_alert"),a("#newdiscussionbody textarea").addClass("empty_field_alert")})}},ia=function(){1==a("#quickreplycontainer").length&&(i.quickReply.dialog=a("#quickreplycontainer").remove(),i.quickReply.path=i.quickReply.dialog.find("form").attr("action"),i.quickReply.title=i.quickReply.dialog.find(".quickdialogtop span"),i.quickReply.prefix=i.quickReply.title.html()),a("#region-main").on("click","button.of_reply",function(b){return b.stopPropagation(),a(this).hasClass("wait_for_dialog")?void a("#quicknew"+i.currentDialog+' button[data-action="cancel"]').click():null!=i.currentDialog?(i.pendingAction=a(this),void a("#quicknew"+i.currentDialog+' button[data-action="cancel"]').click()):(a(this).addClass("wait_for_dialog"),void ja(a(this).closest(".ouilforum_post")))}),a("#region-main").on("click","#cancelquickpost",function(b){b.preventDefault(),R(a("#quicknewpost"))&&la(!1)}),a("#region-main").on("click","#sendquickpost",function(a){a.preventDefault(),w(!1)}),a("#region-main").on("click","#quickedittitle",function(b){b.preventDefault(),a("#newposttop").addClass("editing"),a("#quickreplysubject").focus()}),a("#region-main").on("click","#quickclosetitle",function(b){b.preventDefault(),a("#newposttop").removeClass("editing"),a("#quickreplysubject").val(""),a("#quickedittitle").focus()}),a("#region-main").on("keydown","#quickreplysubject",function(a){13==a.keyCode&&(a.preventDefault(),a.stopPropagation())})},ja=function(b){i.currentDialog="post",i.quickReply.parent=x(b,!0),i.quickReply.parentOrSibling=b.attr("data-postid"),i.quickReply.discussion=t(b,!0),b.after(i.quickReply.dialog),i.quickReply.dialog.find("form").attr("action",i.quickReply.path+i.quickReply.parent),i.quickReply.dialog.find('form input[name="replyto"]').val(i.quickReply.parentOrSibling),i.quickReply.title.html(i.quickReply.prefix+" "+b.find("span.subject .post_subject").html()),a("#quickreplycontainer").removeClass("hidden_element").delay(1).queue(function(){a(this).removeClass("closed_dialog").dequeue()}).delay(200).queue(function(){a(this).find("textarea").focus(),a(this).dequeue()})},ka=function(a){a.find(".empty_field_alert").removeClass("empty_field_alert"),a.find('form input[name="replyto"]').val(""),a.find("#newposttop").removeClass("editing"),u(a,!0),i.quickReply.parent=0,i.quickReply.discussion=0,i.quickReply.parentOrSibling=0},la=function(b){var c=a("#quickreplycontainer");if(0!=c.length){i.currentDialog=null;var d=c.prev(".ouilforum_post").find(".post_reply_button");i.pendingAction&&i.pendingAction[0]==d[0]&&(i.pendingAction=null),b||null!=i.pendingAction?(c.addClass("closed_dialog").addClass("hidden_element"),ka(c),i.quickReply.dialog.find(".quick_dialog_alert").html(""),c.remove(),d.removeClass("wait_for_dialog")):c.addClass("closed_dialog").delay(500).queue(function(){ka(c),c.addClass("hidden_element").dequeue(),v(!0),i.quickReply.dialog.find(".quick_dialog_alert").html(""),c.remove(),d.removeClass("wait_for_dialog"),null==i.pendingAction&&d.focus()}),null!=i.pendingAction&&(i.pendingAction.focus().click(),i.pendingAction=null)}},ma=function(){var b=a(".selector_wrapper_container").length>0;if(b&&(a(".selector_wrapper_container select").each(function(){a(this).wrap('<div class="selector_wrapper"></div>')}),a("#region-main").on("focus",".selector_wrapper select",function(){a(this).closest(".selector_wrapper").addClass("focused")}),a("#region-main").on("blur",".selector_wrapper select",function(){a(this).closest(".selector_wrapper").removeClass("focused")}),i.isIE)){var c,d=a("body").hasClass("dir-rtl");a(".selector_wrapper").each(function(){c=d?-1*parseInt(.4*a(this).width()/2):parseInt(.74*a(this).width()),a(this).css("background-size","6em").css("background-position-x",c)})}},na=function(a){i.compactMode!==a&&(i.compactMode=a,!a&&f.hasOptions()&&f.setDisplay(!0))},oa=function(b,c,d){var e=a("#"+b);0!=e.length&&(c?d?e.removeClass("hidden_element").addClass("active"):e.removeClass("hidden_element").delay(1).queue(function(){a(this).addClass("active").dequeue()}):d?e.removeClass("active").addClass("hidden_element"):e.removeClass("active").delay(1).queue(function(){a(this).addClass("hidden_element").dequeue()}))},pa=function(){var b=a("#d_sub_container > div");b.length>0&&(i.discussionSub=b.remove(),a("#d_sub_container").remove());var c=a("#for_js");c.length>0&&(c.find(".for_js").each(function(){i.newIcons[a(this).attr("id")]=a(this).html()}),c.remove());var d=a("aside.block-region .block_settings .block_digest");d.length?i.settingType="block":(d=a("#region-main-settings-menu div.menu .block_digest"),d.length&&(i.settingType="menu",a("#region-main-settings-menu div.menu .subscribe_digestmode").each(function(){if(!i.digestMenuClass){var b=a(this)[0].className.match(/\s*(.-.-.)\s*/i);null!==b&&(i.digestMenuClass=b[1])}a(this).removeClass("subscribe_digestmode").parent().addClass("subscribe_digestmode")}))),i.settingType&&(i.digestBlockNode=d.parent(),d.hasClass("hidden_element")&&(d.removeClass("hidden_element"),i.digestBlockNode.addClass("hidden_element"),"menu"==i.settingType&&i.digestBlockNode.parent().find(".subscribe_digestmode").addClass("hidden_element")))},qa=function(){var b=a('<input type="email">');i.useHTMLFallback="text"==b[0].type,i.canCopy=document.queryCommandSupported("copy")},ra=function(b){var c=".ouilforum_post";b&&(c=b+" .ouilforum_post"),
a(c).each(function(){var b=a(this).hasClass("closed_post")?"side":"";if(g.hasImages(a(this).find(".post_content"))){var c=g.getLoader("postcontent"+a(this).attr("data-postid"),b);a(this).find(".of_post_body").append(c)}})},sa=function(){var b=["actionsuccess","actionfail","discussionreply","discussionreplies","delete","cancel","deletesure","deletesureplural","copylink:close","copylink:copied","copylink:copy","copylink:failed","copylink:notsupported","copylink:title","recommendpost","unrecommendpost","flag:level","flag:level","flag:menulevel","flag:menulevel0","subscribeforum:no","subscribeforum:nolabel","subscribeforum:yes","subscribeforum:yeslabel","tracking:no","tracking:nolabel","tracking:yes","tracking:yeslabel","lockdiscussion","unlockdiscussion","confirm","confirmdiscardcontent","forwardtitle","forwardsent","subscribediscussion:no","subscribediscussion:nolabel","subscribediscussion:yes","subscribediscussion:yeslabel","opendiscussionthread","closediscussionthread","copylink:gotolink","linktopostfield","forwarderror:empty","forwarderror:invalidemail","confirmdiscardcontentlock","enabled","disabled","postingfailed"],c=[];a.each(b,function(a,b){c.push({key:b,component:"ouilforum"})}),d.get_strings(c).done(function(a){i.str.done=a[0],i.str.fail=a[1],i.str.discussionReply=a[2],i.str.discussionReplies=a[3].replace("{$a}","#"),i.str.del=a[4],i.str.cancel=a[5],i.str.delSure=a[6],i.str.delSurePlural=a[7].replace("{$a}","#"),i.str.copyLinkClose=a[8],i.str.copyLinkCopied=a[9],i.str.copyLinkCopy=a[10],i.str.copyLinkFailed=a[11],i.str.copyLinkNotSupported=a[12],i.str.copyLinkTitle=a[13],i.str.recommendPost=a[14],i.str.unrecommendPost=a[15],i.str.flag=a[16],i.str.flagNone=a[17],i.str.flagMenu=a[18],i.str.flagMenuNone=a[19],i.str.subscribeForumNo=a[20],i.str.subscribeForumNoLabel=a[21],i.str.subscribeForumYes=a[22],i.str.subscribeForumYesLabel=a[23],i.str.trackForumNo=a[24],i.str.trackForumNoLabel=a[25],i.str.trackForumYes=a[26],i.str.trackForumYesLabel=a[27],i.str.lockDiscussion=a[28],i.str.unlockDiscussion=a[29],i.str.confirm=a[30],i.str.confirmDiscardContent=a[31],i.str.forwardTitle=a[32],i.str.forwardSent=a[33],i.str.subscribeDiscussionNo=a[34],i.str.subscribeDiscussionNoLabel=a[35],i.str.subscribeDiscussionYes=a[36],i.str.subscribeDiscussionYesLabel=a[37],i.str.openDiscussionThread=a[38],i.str.closeDiscussionThread=a[39],i.str.copyLinkGoTo=a[40],i.str.linkToPostField=a[41],i.str.forwardErrorEmpty=a[42],i.str.forwardErrorInvalidEmail=a[43],i.str.confirmDiscardContentLock=a[44],i.str.enabled=a[45],i.str.disabled=a[46],i.str.postingFailed=a[47],Y(),$(),Z(),aa(),_(),ra()})};return{init:function(b){if(i.forum=b.forum,i.forumType=b.forumtype,i.forumPage=b.page,i.singlePage=0==i.forumPage&&0==a(".ouilforum_paging").length,i.discussions=a("ul.discussionslist li.discussionslist").length,i.isIE=a("body").hasClass("ie"),h.init(),h.removeParams(["f","d","id","p"]),sa(),f.init(),g.init(a("body").hasClass("dir-rtl")),a.fn.inView=function(b){var c=a(this).offset().top,d=c+a(this).outerHeight(),e=a(window).scrollTop(),f=e+a(window).height();return b?f>=d&&c>=e:d>e&&f>c},a.fn.setClass=function(b,c){c?a(this).addClass(b):a(this).removeClass(b)},a("#subscribeforum").click(J),a("#trackforum").click(N),a("#region-main").on("click","button.discussion_button",j),a("#region-main").on("click keyup",".post_subject",k),a("#region-main").on("click",".of_toggle_addon",function(b){b.stopPropagation(),a("#post"+a(this).attr("data-postid")).click()}),a("#region-main").on("click",'.simpleactionmenu a[data-actiontype="flag"]',r),a("#region-main").on("click","button.ouilforum_recommend",s),a("#region-main").on("click",'.of_post_icons button[data-actiontype="lock"]',W),a("#region-main").on("click",".of_post_icons button.pin_discussion",function(){var b="pin"==a(this).attr("data-action")?1:-1;window.location.href="post.php?pin="+b+"&discussion="+a(this).attr("data-discussionid")}),fa(),ia(),pa(),a("#region-main").on("click",'.simpleactionmenu a[data-action="delete"]',function(b){b.preventDefault(),U(a(this).closest(".ouilforum_post"))}),a("#region-main").on("click",'.simpleactionmenu a[data-action="link"]',function(b){b.preventDefault(),V(a(this))}),a("#region-main").on("click",'.simpleactionmenu a[data-action="forward"]',function(b){b.preventDefault(),ba(a(this).attr("href"),a(this).closest(".ouilforum_post"))}),a("#region-main").on("keyup",".quicknewdialog",function(b){27==b.keyCode&&a(this).find('button[data-action="cancel"]').click()}),a("#region-main").on("click",".subscribediscussion > button",H),i.toast=a("<div></div>").appendTo("body"),i.toast.toast(),ma(),qa(),na(window.innerWidth<768),a(window).resize(function(a){na(window.innerWidth<768)}),b.reply){var c=a("#post"+b.reply+"container button.of_reply");c&&c.click()}}}});