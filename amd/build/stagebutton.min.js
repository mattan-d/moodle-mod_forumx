define(["jquery","core/str"],function(a,b){var c={str:{},dialog:null,stageDialog:{node:null,containerId:null,functionName:null}},d=function(a,b){a.find(".stage_title").html(b)},e=function(a,b){var c=a.find('button[data-action="activate"]'),d=a.find('button[data-action="deactivate"]');b?(c.attr("aria-pressed",!0),d.removeAttr("aria-pressed")):(d.attr("aria-pressed",!0),c.removeAttr("aria-pressed"))},f=function(b,c){b.hasClass("hidden_element")&&!c?(b.removeClass("hidden_element").find(".stage_title").focus(),a("html").on("click.stagedialog",function(b){g(a(b.target))}),a("html").on("focus.stagedialog","body",function(b){g(a(b.target))})):(!b.hasClass("hidden_element")||c)&&(b.addClass("hidden_element"),c||b.prev().focus(),a("html").off(".stagedialog"),j())},g=function(a){0==a.parents("#"+c.stageDialog.id).length&&f(c.stageDialog.node,!0)},h=function(){c.dialog=a('<div class="stage_button_options hidden_element"><span class="stage_title" tabindex="-1"></span><div><button data-action="activate">'+c.str.activate+'</button><button data-action="deactivate">'+c.str.deactivate+"</button></div></div>"),a(".stage_button_container").each(function(){i(a(this))})},i=function(a){var b="on"==a.find("button").attr("data-buttonstate"),d=a.find(".stage_label").remove(),f=c.dialog.clone();f.find(".stage_title").html(d.html()),e(f,b),a.append(f)},j=function(){c.stageDialog.node=null,c.stageDialog.id=null,c.stageDialog.functionName=null},k=function(){b.get_strings([{key:"button:activate",component:"ouilforum"},{key:"button:deactivate",component:"ouilforum"}]).done(function(a){c.str.activate=a[0],c.str.deactivate=a[1],h()})};return{init:function(){k(),a("#region-main").on("keyup",".stage_button_options",function(a){27==a.keyCode&&c.stageDialog.node&&f(c.stageDialog.node)}),a("#region-main").on("click",".stage_button_options button",function(){"true"!=a(this).attr("aria-pressed")&&c.stageDialog.functionName&&c.stageDialog.functionName(a(this).closest(".stage_button_options").prev())})},setOptions:function(a,b,d){c.stageDialog.node=a,c.stageDialog.id=b,c.stageDialog.functionName=d},hasOptions:function(){return null!=c.stageDialog.node},clearOptions:function(){j()},setDisplay:function(a){f(c.stageDialog.node,a)},setState:function(a,b){e(a,b)},addDialog:function(a){i(a)},updateTitle:function(a,b){d(a,b)}}});